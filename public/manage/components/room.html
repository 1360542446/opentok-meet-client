<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3">
    <h1 class="h2">Rooms</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#new-room">New</button>
        </div>
    </div>
</div>
<div id="grid-room" class="table-responsive">
    <table class="table table-striped table-sm">
        <thead>
            <tr>
                <th data-column-id="name">Name</th>
                <th data-column-id="sessionId">Session ID</th>
                <th data-column-id="createTime">Create Time</th>
                <th>Commands</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
<div id="new-room" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="newRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newRoomModalLabel">New Room</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="message-text" class="col-form-label">Name:</label>
                        <input type="text" class="form-control" id="room-name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="createRoom()">Save</button>
            </div>
        </div>
    </div>
</div>
<div id="room-detail" class="modal fade bd-example-modal-xl" tabindex="-1" role="dialog" aria-labelledby="room-detail-label"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="room-detail-label">Manage Room</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group row">
                        <label for="room-detail-name" class="col-sm-2 col-form-label">Name</label>
                        <div class="col-sm-10">
                            <input type="text" readonly class="form-control-plaintext" id="room-detail-name">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="room-detail-session-id" class="col-sm-2 col-form-label">SessionId</label>
                        <div class="col-sm-10">
                            <input type="text" readonly class="form-control-plaintext" id="room-detail-session-id">
                        </div>
                    </div>
                </form>
                <div id="grid-token" class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th data-column-id="user">User</th>
                                <th data-column-id="role">Role</th>
                                <th data-column-id="token" style="display: none">Token</th>
                                <th data-column-id="expireTime">Expire Time</th>
                                <th>Commands</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                <form>
                    <div class="form-group row">
                        <label for="room-detail-user" class="col-sm-3 col-form-label" style="text-align:right">UserName</label>
                        <div class="col-sm-6">
                            <input type="text" class="form-control" id="room-detail-user">
                        </div>
                        <button type="button" class="col-sm-3 btn btn-primary mb-2" onclick="createToken()">Create New Token</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    var roomServiceAPI = Config.serviceBasicUrl + '/room';
    var editTemplate = "<button title=\"edit\" type=\"button\" class=\"btn btn-xs btn-default command-edit\" onclick=\"showRoomDetails(this)\"><i class=\"fa fa-pencil-square-o\" aria-hidden=\"true\"></i></button>";
    var copyRoomAccessUrlTemplate = "<button title=\"get url\" type=\"button\" class=\"btn btn-xs btn-default command-edit\" onclick=\"getMeetAccessUrl(this)\"><i class=\"fa fa-link\" aria-hidden=\"true\"></i></i></button>";
    var currentRoomDetails = null;

    listRoom();

    function listRoom() {
        doFetch(roomServiceAPI)
            .catch(err => console.error('Error ' + err))
            .then(data => {
                Util.generateTabelHTML("grid-room", data, [editTemplate], function (column, value, parent) {
                    if (column != 'name') {
                        return "<td><span  data-toggle=\"tooltip\" title=\"" + value + "\">" + Util.truncateText(value) + "</span></td>";
                    }
                    else {
                        return "<td>" + value + "</td>";
                    }
                });
            });
    }

    function createRoom() {
        var room = $('#room-name').val();
        doFetch(roomServiceAPI + '/createroom?room=' + room, {
            method: 'POST', // or 'PUT'
            body: JSON.stringify({}),
            headers: new Headers({
                'Content-Type': 'application/json'
            })
        })
            .catch(err => console.error('Error ' + err))
            .then(()=>{
                $('#new-room').modal('hide');
            });
    }

    function loadRoomDetails(room) {
        $('#room-detail-user').val('');
        doFetch(Config.serviceBasicUrl + '/room/getroom?room=' + room)
            .catch(err => {
                console.error(err);
            })
            .then(data => {
                currentRoomDetails = data;
                $('#room-detail-name').val(data.name);
                $('#room-detail-session-id').val(data.sessionId);
                Util.generateTabelHTML("grid-token", data.tokens, [copyRoomAccessUrlTemplate], function (column, value, parent) {
                    return `<td style="${column === 'token' ? "display:none" : ""}">${value}</td>`;
                });
                $('#room-detail').modal('show')
            });
    }

    function createToken() {
        let room = $('#room-detail-name').val();
        let userName = $('#room-detail-user').val();
        doFetch(roomServiceAPI + '/generateToken?room=' + room + "&user=" + userName)
            .catch(err => {
                console.error(err);
            })
            .then(data => {
                loadRoomDetails(room);
            });
    }

    function showRoomDetails(ele) {
        let room = Util.getCurrentTrColumnValue(ele.parentNode.parentNode, 'name');
        loadRoomDetails(room);
    }

    function getMeetAccessUrl(ele) {
        if (currentRoomDetails) {
            let token = Util.getCurrentTrColumnValue(ele.parentNode.parentNode, 'token');
            let accessOptions = {
                apiKey: currentRoomDetails.apiKey,
                sessionId: currentRoomDetails.sessionId,
                p2p: currentRoomDetails.p2p,
                token
            }

            let urlParamters = '';
            for (const key in accessOptions) {
                urlParamters += '&'
                urlParamters += key + '=' + accessOptions[key];
            }
            alert(urlParamters);
        }
    }

    function doFetch(url, options = {}) {
        return new Promise((resolvd, reject) => {
            fetch(url, options)
                .then(res => res.json())
                .catch(reject)
                .then(resolvd);
        })
    }

//# sourceURL=manage/components/room.html
</script>